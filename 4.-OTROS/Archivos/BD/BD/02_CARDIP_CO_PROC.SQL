USE [BD_CARDIP]
GO


--================================================================================
--SISTEMA			: CARDIP ADMIN
--OBJETIVO			: actualizar la observacion
--CREADO			: vpipa
--FECHA     		: 28/06/2021 18:47:27
--PARAMETROS        :	@P_ID_SOLICITUD			IDENTIFICADOR DE LA TABLA
--EJECUTAR          : [SC_CARDIP].[USP_CD_CARNE_IDENTIDAD_ACTUALIZAR_ESTADO_OBSERVADO]
--MODIFICACIONES
--AUTOR                       FECHA      N° REQ.      MOTIVO
--================================================================================
IF NOT EXISTS (SELECT OBJECT_ID FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[SC_CARDIP].[USP_CD_CARNE_IDENTIDAD_ACTUALIZAR_ESTADO_OBSERVADO]') AND TYPE IN (N'P', N'PC'))
BEGIN
EXEC DBO.SP_EXECUTESQL @STATEMENT = N'CREATE PROCEDURE [SC_CARDIP].[USP_CD_CARNE_IDENTIDAD_ACTUALIZAR_ESTADO_OBSERVADO] AS' 
END
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO	
ALTER PROCEDURE [SC_CARDIP].[USP_CD_CARNE_IDENTIDAD_ACTUALIZAR_ESTADO_OBSERVADO]
@RELI_SREG_LINEA_ID		SMALLINT,
@P_ESTADO_ID				SMALLINT,
@P_OBSERVACION	VARCHAR(250),
@CAID_SUSUARIOMODIFICACION smallint
AS
BEGIN
	BEGIN TRY    
			BEGIN	
			    --------------------------------
				DECLARE @NUEVO_DERE_SCODIGO SMALLINT, @DERE_SESTADO_ID SMALLINT

				SELECT @NUEVO_DERE_SCODIGO= (ISNULL(MAX(DERE_SCODIGO),0)+1) FROM SC_REGLINEA.RL_DETALLE_REGISTRO_LINEA WHERE DERE_SREG_LINEA_ID=@RELI_SREG_LINEA_ID
				SELECT @DERE_SESTADO_ID= ESTA_SESTADOID  FROM SC_MAESTRO.MA_ESTADO AS ES WHERE ES.ESTA_CESTADO='A' AND ES.ESTA_VGRUPO='REG LINEA - ESTADO' AND ESTA_VDESCRIPCIONCORTA='OBSERVADO'
				----ACTUALIZA LA CABECERA
				UPDATE SC_REGLINEA.RL_REGISTRO_LINEA SET RELI_SESTADO_ID=@DERE_SESTADO_ID, RELI_DFECHA_MODIFICACION=GETDATE() WHERE RELI_SREG_LINEA_ID=@RELI_SREG_LINEA_ID
				----INSERTA EL DETALLE
				INSERT INTO  SC_REGLINEA.RL_DETALLE_REGISTRO_LINEA(DERE_SREG_LINEA_ID, DERE_SCODIGO, DERE_SESTADO_ID, DERE_VOBSERVACION,DERE_FECHACREACION)
				VALUES (@RELI_SREG_LINEA_ID, @NUEVO_DERE_SCODIGO,@DERE_SESTADO_ID, @P_OBSERVACION,GETDATE())
				
		
			END
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE() AS ERRORMESSAGE;
	END CATCH
END

GO

/*################################################## OBTENER CORREO DEL CIUDADANO ############## */
--================================================================================
--SISTEMA			: CARDIP ADMIN
--OBJETIVO			: obtener correo del ciudadano
--CREADO			: vpipa
--FECHA     		: 28/06/2021 18:47:27
--PARAMETROS        :	@@P_CARNE_IDENTIDAD_ID			IDENTIFICADOR DE LA TABLA
--EJECUTAR          : [SC_CARDIP].[USP_CD_CARNE_IDENTIDAD_OBTENER_CORREO] 162
--MODIFICACIONES
--AUTOR                       FECHA      N° REQ.      MOTIVO
--================================================================================
IF NOT EXISTS (SELECT OBJECT_ID FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[SC_CARDIP].[USP_CD_CARNE_IDENTIDAD_OBTENER_CORREO]') AND TYPE IN (N'P', N'PC'))
BEGIN
EXEC DBO.SP_EXECUTESQL @STATEMENT = N'CREATE PROCEDURE [SC_CARDIP].[USP_CD_CARNE_IDENTIDAD_OBTENER_CORREO] AS' 
END
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO	
ALTER PROCEDURE [SC_CARDIP].[USP_CD_CARNE_IDENTIDAD_OBTENER_CORREO]

@P_RELI_SREG_LINEA_ID		SMALLINT
AS
BEGIN
	BEGIN TRY    
			BEGIN	
				SELECT  RELI_VDP_CORREO_ELECTRONICO,RELI_VIN_CORREO_ELECTRONICO,RELI_VDP_NUMERO_REG_LINEA
				FROM SC_REGLINEA.RL_REGISTRO_LINEA 
				WHERE RELI_SREG_LINEA_ID = @P_RELI_SREG_LINEA_ID
			END
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE() AS ERRORMESSAGE;
	END CATCH
END


go
/*##################################################*/
--================================================================================
--SISTEMA			: CARDIP ADMIN
--OBJETIVO			: registrar detalle de registro en linea desde la palicacion cardip admin 
--CREADO			: vpipa
--FECHA     		: 28/06/2021 18:47:27
--PARAMETROS        :@P_ID_SOLICITUD			IDENTIFICADOR DE LA TABLA
--EJECUTAR          : [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE]
--MODIFICACIONES
--AUTOR                       FECHA      N° REQ.      MOTIVO
--================================================================================
IF NOT EXISTS (SELECT OBJECT_ID FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE]') AND TYPE IN (N'P', N'PC'))
BEGIN
EXEC DBO.SP_EXECUTESQL @STATEMENT = N'CREATE PROCEDURE [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE] AS' 
END
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO	
ALTER PROCEDURE [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE]
@DERE_SREG_LINEA_ID		SMALLINT,
@P_RELI_SESTADO_ID				SMALLINT,
@P_OBSERVACION	VARCHAR(250),
@CAID_SUSUARIOMODIFICACION smallint
AS
BEGIN
	BEGIN TRY    
			BEGIN	
			declare @NUEVO_DERE_SCODIGO SMALLINT,@P_RELI_SESTADO_ID_OSB SMALLINT, @P_RELI_SESTADO_ID_APROBADO SMALLINT
					----ACTUALIZAR ELESTADO A observado al estado previo Enviado
					SELECT @P_RELI_SESTADO_ID= ESTA_SESTADOID FROM SC_MAESTRO.MA_ESTADO WHERE ESTA_VGRUPO='REG LINEA - ESTADO' AND ESTA_VDESCRIPCIONCORTA='ENVIADO' AND ESTA_CESTADO='A'
					SELECT @P_RELI_SESTADO_ID_APROBADO= ESTA_SESTADOID FROM SC_MAESTRO.MA_ESTADO WHERE ESTA_VGRUPO='REG LINEA - ESTADO' AND ESTA_VDESCRIPCIONCORTA='APROBADO' AND ESTA_CESTADO='A'
					SELECT  @P_RELI_SESTADO_ID_OSB=ESTA_SESTADOID FROM SC_MAESTRO.MA_ESTADO WHERE ESTA_VGRUPO='REG LINEA - ESTADO' AND ESTA_VDESCRIPCIONCORTA='OBSERVADO'
					----
					UPDATE SC_REGLINEA.RL_REGISTRO_LINEA SET RELI_SESTADO_ID=@P_RELI_SESTADO_ID, RELI_DFECHA_MODIFICACION=GETDATE() WHERE RELI_SREG_LINEA_ID=@DERE_SREG_LINEA_ID 
					----
					UPDATE SC_REGLINEA.RL_DETALLE_REGISTRO_LINEA 
					SET DERE_SESTADO_ID =@P_RELI_SESTADO_ID_APROBADO,
					DERE_FECHACREACION=GETDATE(),
					DERE_VOBSERVACION=''
					WHERE DERE_SREG_LINEA_ID=@DERE_SREG_LINEA_ID AND DERE_SESTADO_ID=@P_RELI_SESTADO_ID_OSB

			END
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE() AS ERRORMESSAGE;
	END CATCH
END

GO  

/*#################################################detalle por carnet#############*/
--================================================================================
--SISTEMA			: CARDIP ADMIN
--OBJETIVO			: registrar detalle de registro en linea desde la palicacion cardip admin
--CREADO			: vpipa
--FECHA     		: 28/06/2021 18:47:27
--PARAMETROS        :@@P_CARNE_IDENTIDAD_ID			IDENTIFICADOR DE LA TABLA
--EJECUTAR          : [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE_ATENDIDO]
--MODIFICACIONES
--AUTOR                       FECHA      N° REQ.      MOTIVO
--================================================================================

IF NOT EXISTS (SELECT OBJECT_ID FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE_ATENDIDO]') AND TYPE IN (N'P', N'PC'))
BEGIN
EXEC DBO.SP_EXECUTESQL @STATEMENT = N'CREATE PROCEDURE [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE_ATENDIDO] AS' 
END
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO	
ALTER  PROCEDURE [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE_ATENDIDO]
@P_CARNE_IDENTIDAD_ID		SMALLINT,
@P_MENSAJE varchar(250)
AS
BEGIN
	BEGIN TRY   
			BEGIN	
							    --------------------------------
				DECLARE @RELI_SREG_LINEA_ID INT,@NUEVO_DERE_SCODIGO SMALLINT, @DERE_SESTADO_ID SMALLINT
				SET @RELI_SREG_LINEA_ID=0
				SELECT @RELI_SREG_LINEA_ID = RELI_SREG_LINEA_ID FROM SC_REGLINEA.RL_REGISTRO_LINEA WHERE RELI_ICARNE_IDENTIDAD_ID= @P_CARNE_IDENTIDAD_ID
				IF (@RELI_SREG_LINEA_ID>0)BEGIN
					SELECT @NUEVO_DERE_SCODIGO= (ISNULL(MAX(DERE_SCODIGO),0)+1) FROM SC_REGLINEA.RL_DETALLE_REGISTRO_LINEA WHERE DERE_SREG_LINEA_ID=@RELI_SREG_LINEA_ID
					SELECT @DERE_SESTADO_ID= ESTA_SESTADOID  FROM SC_MAESTRO.MA_ESTADO AS ES WHERE ES.ESTA_CESTADO='A' AND ES.ESTA_VGRUPO='REG LINEA - ESTADO' AND ESTA_VDESCRIPCIONCORTA='ATENDIDO'
					----ACTUALIZA LA CABECERA
					UPDATE SC_REGLINEA.RL_REGISTRO_LINEA SET RELI_SESTADO_ID=@DERE_SESTADO_ID, RELI_DFECHA_MODIFICACION=GETDATE() WHERE RELI_SREG_LINEA_ID=@RELI_SREG_LINEA_ID
					----INSERTA EL DETALLE
					INSERT INTO  SC_REGLINEA.RL_DETALLE_REGISTRO_LINEA(DERE_SREG_LINEA_ID, DERE_SCODIGO, DERE_SESTADO_ID,   DERE_VOBSERVACION  ,DERE_FECHACREACION)
					VALUES (@RELI_SREG_LINEA_ID, @NUEVO_DERE_SCODIGO,@DERE_SESTADO_ID, @P_MENSAJE,GETDATE())
				END
		
			END
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE() AS ERRORMESSAGE;
	END CATCH
END
go
/*#################################################detalle por carnet#############*/
--================================================================================
--SISTEMA			: CARDIP ADMIN
--OBJETIVO			: registrar detalle de registro en linea desde la palicacion cardip admin
--CREADO			: vpipa
--FECHA     		: 05/07/2021 18:47:27
--PARAMETROS        :@@P_CARNE_IDENTIDAD_ID			IDENTIFICADOR DE LA TABLA
--EJECUTAR          : [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE_APROBADO]
--MODIFICACIONES
--AUTOR                       FECHA      N° REQ.      MOTIVO
--================================================================================

IF NOT EXISTS (SELECT OBJECT_ID FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE_APROBADO]') AND TYPE IN (N'P', N'PC'))
BEGIN
EXEC DBO.SP_EXECUTESQL @STATEMENT = N'CREATE PROCEDURE [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE_APROBADO] AS' 
END
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO	
ALTER  PROCEDURE [SC_CARDIP].[USP_CD_REGITROLINEA_REGISTRAR_DETALLE_APROBADO]
@DERE_SREG_LINEA_ID		SMALLINT
AS
BEGIN
	BEGIN TRY   
			BEGIN	
				declare @NUEVO_DERE_SCODIGO SMALLINT, @DERE_SESTADO_ID SMALLINT

					
					SELECT @DERE_SESTADO_ID= ESTA_SESTADOID  FROM SC_MAESTRO.MA_ESTADO AS ES WHERE ES.ESTA_CESTADO='A' AND ES.ESTA_VGRUPO='REG LINEA - ESTADO' AND ESTA_VDESCRIPCIONCORTA='APROBADO'
					IF NOT EXISTS(SELECT DERE_SREG_LINEA_ID FROM SC_REGLINEA.RL_DETALLE_REGISTRO_LINEA WHERE DERE_SREG_LINEA_ID=@DERE_SREG_LINEA_ID AND DERE_SESTADO_ID= @DERE_SESTADO_ID)
					BEGIN
						SELECT @NUEVO_DERE_SCODIGO= (ISNULL(MAX(DERE_SCODIGO),0)+1) FROM SC_REGLINEA.RL_DETALLE_REGISTRO_LINEA WHERE DERE_SREG_LINEA_ID=@DERE_SREG_LINEA_ID
						INSERT INTO  SC_REGLINEA.RL_DETALLE_REGISTRO_LINEA(DERE_SREG_LINEA_ID, DERE_SCODIGO, DERE_SESTADO_ID, DERE_VOBSERVACION,DERE_FECHACREACION)
						VALUES (@DERE_SREG_LINEA_ID, @NUEVO_DERE_SCODIGO,@DERE_SESTADO_ID, '',GETDATE())
					END
			END
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE() AS ERRORMESSAGE;
	END CATCH
END
go
/*=#######################################*/
--======================================================================
--SISTEMA		:	
--OBJETIVO		: obtener el id del registro en linea
--CREADO POR	: VPIPA	
--FECHA			: 28/06/2021
--PARAMETROS		:	
--EJECUTAR		:	[SC_CARDIP].[USP_CD_CONSULTA_REGLINEA_XIDCARNET] '162'
--MODIFICACIONES
--AUTOR		FECHA		N° REQ		MOTIVO		
--======================================================================
IF NOT EXISTS (SELECT OBJECT_ID FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[SC_CARDIP].[USP_CD_CONSULTA_REGLINEA_XIDCARNET]') AND TYPE IN (N'P', N'PC'))
BEGIN
EXEC DBO.SP_EXECUTESQL @STATEMENT = N'CREATE PROCEDURE [SC_CARDIP].[USP_CD_CONSULTA_REGLINEA_XIDCARNET] AS' 
END
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO	
ALTER PROCEDURE [SC_CARDIP].[USP_CD_CONSULTA_REGLINEA_XIDCARNET]
@CAID_ICARNE_IDENTIDADID    smallint
AS
BEGIN
	BEGIN TRY
	
			SELECT	top 1	RELI_SREG_LINEA_ID AS REGLINEA_ID
			FROM		SC_REGLINEA.RL_REGISTRO_LINEA RL (NOLOCK)
			INNER JOIN [SC_CARDIP].[CD_CARNE_IDENTIDAD] caid on caid.[CAID_ICARNE_IDENTIDADID]=rl.RELI_ICARNE_IDENTIDAD_ID
			WHERE		caid.[CAID_ICARNE_IDENTIDADID]	=	@CAID_ICARNE_IDENTIDADID
			AND			RELI_CESTADO				=	'A'		
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE() AS ErrorMessage;
	END CATCH
	RETURN @@IDENTITY
END

go
/*=#######################################obtener mensaje Estado#############*/
--======================================================================
--SISTEMA		:	
--OBJETIVO		: obtener el id del registro en linea
--CREADO POR	: VPIPA	
--FECHA			: 28/06/2021
--PARAMETROS		:	
--EJECUTAR		:	[SC_CARDIP].[USP_CD_CONSULTA_MENSAJE_ESTADO] '162'
--MODIFICACIONES
--AUTOR		FECHA		N° REQ		MOTIVO		
--======================================================================
IF NOT EXISTS (SELECT OBJECT_ID FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[SC_CARDIP].[USP_CD_CONSULTA_MENSAJE_ESTADO]') AND TYPE IN (N'P', N'PC'))
BEGIN
EXEC DBO.SP_EXECUTESQL @STATEMENT = N'CREATE PROCEDURE [SC_CARDIP].[USP_CD_CONSULTA_MENSAJE_ESTADO] AS' 
END
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO	
ALTER PROCEDURE [SC_CARDIP].[USP_CD_CONSULTA_MENSAJE_ESTADO]
@CAID_ICARNE_IDENTIDADID    smallint,
@MEES_SESTADOID smallint
AS
BEGIN
	BEGIN TRY
			SELECT	me.MEES_VMENSAJE
			FROM	[SC_CARDIP].[CD_MENSAJE_ESTADO]	 me			
			WHERE	MEES_SESTADOID	=	@MEES_SESTADOID
			AND		MEES_CESTADO	=	'A'		
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE() AS ErrorMessage;
	END CATCH
	RETURN @@IDENTITY
END



